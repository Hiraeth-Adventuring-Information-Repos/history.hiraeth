<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiraeth Timeline: A Celestial Descent</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">
    <!-- TailwindCSS for layout and utilities -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: EB Garamond (Greco-Roman serif feel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">

    <style>
        /* --- Custom Styles --- */
        html {
            scroll-behavior: smooth;
        }
        body {
            /* EB Garamond is our primary font */
            font-family: 'EB Garamond', serif;
            /* A dark, cosmic background for the page */
            background-color: #0c0a1a;
            color: #f0f0f0;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            /* Heavier font weight for titles */
            font-weight: 700;
            letter-spacing: 0.025em;
        }

        /* --- Timeline Layer Styling --- */
        .timeline-layer {
            /* Each layer is at least one screen high */
            min-height: 100vh;
            padding: 6rem 2.5rem; /* 6rem top/bottom, 2.5rem left/right */
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid;
            
            /* --- PARALLAX EFFECT --- */
            /* This creates the simple parallax "descent" */
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        /* --- Layer 6: Modern Era (Acropolis) --- */
        #modern-era {
            /* Bright marble/stucco background */
            background-image: linear-gradient(to bottom, #ffffff, #e8e8e8);
            color: #333;
            border-bottom-color: #d1d1d1;
        }
        
        /* Greek Key border effect */
        #modern-era::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 20px;
            /* Repeating Greek Key pattern */
            background-image: linear-gradient(135deg, #bbb 25%, transparent 25%), linear-gradient(225deg, #bbb 25%, transparent 25%), linear-gradient(45deg, #bbb 25%, transparent 25%), linear-gradient(315deg, #bbb 25%, transparent 25%);
            background-position: -5px -5px, -5px -5px, 0 0, 0 0;
            background-size: 10px 10px;
            background-repeat: repeat-x;
            /* Use a solid bg for the greek key to work on a gradient */
            background-color: #e8e8e8;
        }

        /* --- Layer 5: Unification Age (Republic) --- */
        #unification-age {
            background-image: linear-gradient(to bottom, #4a4a6a, #3a3a5a);
            color: #e0e0e0;
            border-bottom-color: #6a6a8a;
        }

        /* --- Layer 4: Mythic Age (Dusk) --- */
        #mythic-age {
            background-image: linear-gradient(to bottom, #3a3a5a, #2a2a4a);
            color: #d0d0d0;
            border-bottom-color: #4a4a6a;
        }

        /* --- Layer 3: Classical Age (Night) --- */
        #classical-age {
            background-image: linear-gradient(to bottom, #2a2a4a, #1a1a3a);
            color: #c0c0c0;
            border-bottom-color: #3a3a5a;
        }

        /* --- Layer 2: Ancient Era (Star-Chart) --- */
        #ancient-era {
            /* Deep space */
            background-image: radial-gradient(ellipse at 20% 80%, #1a1a3a 0%, rgba(26,26,58,0) 50%),
                                radial-gradient(ellipse at 80% 30%, #3a2a4a 0%, rgba(58,42,74,0) 40%),
                                #0c0a1a;
            color: #f0f0f0;
            border-bottom-color: #1a1a3a;
        }

        /* --- Layer 1: Antediluvian (Primordial Chaos) --- */
        #antediluvian-age {
            /* Swirling dark nebula effect */
            background-image: radial-gradient(ellipse at 70% 30%, #4a00e0 0%, rgba(74,0,224,0) 60%),
                                radial-gradient(ellipse at 30% 70%, #002266 0%, rgba(0,34,102,0) 50%),
                                #0c0a1a;
            border-bottom-color: #4a00e0;
        }

        /* --- Event Card Styling --- */
        .event-trigger {
            /* This is the new common class for all clickable items */
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        .event-card {
            border-radius: 12px;
            padding: 1.5rem;
            border-width: 1px;
        }

        /* Modern "Marble Plaque" Card */
        .event-card.modern {
            background: #ffffff;
            border-color: #d1d1d1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .event-card.modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .event-card.modern .event-date { color: #555; font-weight: 700; }
        .event-card.modern .event-title { color: #222; }

        /* Unification "Marble Slab" Card */
        .event-card.unification {
            background: rgba(255, 255, 255, 0.1);
            border-color: #aaa;
            backdrop-filter: blur(3px);
        }
        .event-card.unification:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .event-card.unification .event-date { color: #ccc; }
        .event-card.unification .event-title { color: #fff; }

        /* Mythic "Broken Mosaic" Card */
        .event-card.mythic {
            background: rgba(255, 255, 255, 0.05);
            border-color: #8a63f5;
            opacity: 0.8;
            border-radius: 4px 20px 8px 15px; /* Irregular shape */
        }
        .event-card.mythic:hover {
            opacity: 1;
            transform: scale(1.03);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(138, 99, 245, 0.2);
        }
        .event-card.mythic .event-date { color: #c0b0f0; }
        .event-card.mythic .event-title { color: #e0d8ff; }

        /* Classical "Mosaic Tile" Card */
        .event-card.classical {
            background: rgba(200, 200, 220, 0.1);
            border-color: #999;
            border-width: 2px;
            border-radius: 2px; /* Sharp edges */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .event-card.classical:hover {
            transform: scale(1.02);
            background: rgba(200, 200, 220, 0.2);
            border-color: #fff;
        }
        .event-card.classical .event-date { color: #bbb; }
        .event-card.classical .event-title { color: #e0e0e0; }

        /* Ancient "Runic Fragment" Card (Layer 1) */
        .event-card.ancient {
            background: rgba(26, 26, 46, 0.7); /* Translucent */
            border-color: #4a00e0;
            box-shadow: 0 4px 12px rgba(74, 0, 224, 0.2);
            backdrop-filter: blur(5px);
        }
        .event-card.ancient:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(74, 0, 224, 0.4);
            border-color: #8a63f5;
        }
        .event-card.ancient .event-date { color: #aaa; font-style: italic; }
        .event-card.ancient .event-title { color: #f0f0f0; }
        
        /* --- Layer 2: Star-Chart Styling --- */
        .star-chart-container {
            position: relative;
            width: 100%;
            height: 100vh; /* Full screen height for positioning */
            max-height: 1000px;
        }

        .star {
            position: absolute;
            border-radius: 50%;
            background: #ffffff;
            /* Brighter shadow for filler stars */
            box-shadow: 0 0 15px #fff, 0 0 30px #fff;
            animation: twinkle 4s infinite alternate;
        }
        .star.clickable {
            /* Clickable stars are bigger and glow more */
            width: 12px;
            height: 12px;
            /* Brighter shadow for clickable stars, added a third glow */
            box-shadow: 0 0 20px #fff, 0 0 40px #8a63f5, 0 0 10px #f0f;
        }
        .star.clickable:hover {
            animation-play-state: paused;
            transform: scale(2.5);
            /* Brighter shadow on hover */
            box-shadow: 0 0 30px #f0f, 0 0 50px #8a63f5, 0 0 10px #fff;
        }
        .star-label {
            position: absolute;
            color: #aaa;
            font-size: 0.875rem; /* 14px */
            /* New centering styles */
            top: 100%; /* Position top of label at bottom of star */
            left: 50%;  /* Position left of label at center of star */
            transform: translateX(-50%) translateY(5px); /* Center horizontally, add 5px padding */
            white-space: nowrap;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        .star.clickable:hover .star-label {
            opacity: 1;
            color: #fff;
            /*
             * Counter-scale the font-size on hover.
             * The parent div scales by 2.5x. We want a final font size of ~1.25rem (20px).
             * 20px / 2.5 = 8px, which is 0.5rem.
            */
            font-size: 0.5rem;
            /*
             * Adjust Y-translate padding. We want ~10px of padding.
             * 10px / 2.5 = 4px.
            */
            transform: translateX(-50%) translateY(4px);
        }

        /* Twinkle Animation */
        @keyframes twinkle {
            0% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* --- Modal Styling --- */
        #modal-backdrop { transition: opacity 0.3s ease; }
        #modal-container { transition: all 0.3s ease; }

        /* Base style for all modal content */
        .modal-content-base {
            width: 100%;
            max-width: 3xl; /* 768px */
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 2.5rem;
            position: relative;
        }
        
        /* Theme 1: Scroll (Modern) */
        .modal-theme-scroll {
            background: #fdf5e6; /* Parchment color */
            color: #5d4037; /* Brown text */
            border: 8px solid #8d6e63;
            border-image: linear-gradient(to bottom, #8d6e63, #bcaaa4) 1 100%;
        }
        .modal-theme-scroll .modal-date { color: #795548; }
        .modal-theme-scroll .rumor-box { border-top: 2px dashed #bcaaa4; background: #faf3e0; }
        .modal-theme-scroll #modal-close-btn { color: #795548; }
        .modal-theme-scroll #modal-close-btn:hover { color: #3e2723; }

        /* Theme 2: Stone Tablet (Ancient) */
        .modal-theme-tablet {
            background: #4a4a4a; /* Dark stone */
            color: #f0f0f0;
            border: 2px solid #222;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
        }
        .modal-theme-tablet .modal-date { color: #ccc; font-style: italic; }
        .modal-theme-tablet .rumor-box { border-top: 2px dashed #777; background: #3a3a3a; }
        .modal-theme-tablet #modal-close-btn { color: #ccc; }
        .modal-theme-tablet #modal-close-btn:hover { color: #fff; }

        /* Theme 3: Marble (Unification) */
        .modal-theme-marble {
            background: #e5e5e5;
            color: #333;
            border: 4px solid #aaa;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        .modal-theme-marble .modal-date { color: #555; }
        .modal-theme-marble .rumor-box { border-top: 2px dashed #999; background: #d5d5d5; }
        .modal-theme-marble #modal-close-btn { color: #777; }
        .modal-theme-marble #modal-close-btn:hover { color: #000; }
        
        /* Theme 4: Mosaic (Classical/Mythic) */
        .modal-theme-mosaic {
            background: #c5b8a5; /* Terracotta */
            color: #4a3c32;
            border: 6px solid #795548; /* Grout/edge */
        }
        .modal-theme-mosaic .modal-date { color: #6d4c41; }
        .modal-theme-mosaic .rumor-box { border-top: 2px dashed #a1887f; background: #b5a895; }
        .modal-theme-mosaic #modal-close-btn { color: #5d4037; }
        .modal-theme-mosaic #modal-close-btn:hover { color: #3e2723; }

        /* Modal Close Button */
        #modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2.5rem;
            line-height: 1;
            font-weight: 300;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        /* Rumor Box */
        .rumor-box {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
        }
        .rumor-box h4 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-style: normal;
        }
        .rumor-box p {
            font-style: italic;
            opacity: 0.9;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Sidebar Navigation -->
    <button id="sidebar-toggle" class="fixed top-4 left-4 z-50 bg-gray-800 bg-opacity-50 text-white p-2 rounded-md hover:bg-opacity-75 transition-opacity">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>

    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-gray-900 bg-opacity-90 backdrop-blur-sm text-white z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <nav class="mt-16">
            <a href="#modern-era" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Modern Era</a>
            <a href="#unification-age" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Unification Age</a>
            <a href="#mythic-age" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Mythic Age</a>
            <a href="#classical-age" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Classical Age</a>
            <a href="#ancient-era" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Ancient Era</a>
            <a href="#antediluvian-age" class="block py-3 px-6 hover:bg-gray-700 transition-colors">Antediluvian Age</a>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <main>
        <!-- Page Header -->
        <header class="text-center py-20 px-4" style="background: radial-gradient(ellipse at 50% 100%, #1a1a2e 0%, #0c0a1a 80%);">
            <h1 class="text-6xl md:text-7xl font-bold text-white mb-4">The Hiraeth Timeline</h1>
            <p class="text-2xl text-gray-300 italic">A Celestial Descent Through the Ages</p>
        </header>

        <!-- 
        ========================================
        LAYER 6: THE MODERN ERA
        THEME: Bright Acropolis / Marble
        ========================================
        -->
        <section id="modern-era" class="timeline-layer" style="scroll-margin-top: -1px;">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Modern Era</h2>
                <p class="text-xl text-center text-gray-600 mb-12 italic">"History as written by the victors. Clear, precise, and absolute."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-500 hover:text-gray-800 transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Modern Era. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Dynamically Loaded -->
                </div>
            </div>
        </section>

        <!-- 
        ========================================
        LAYER 5: THE UNIFICATION AGE
        THEME: Marble Republic / Dusk
        ========================================
        -->
        <section id="unification-age" class="timeline-layer">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Unification Age</h2>
                <p class="text-xl text-center text-gray-300 mb-12 italic">"The age of treaties and mortals. When civilization began to write its own laws."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-400 hover:text-white transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Unification Age. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Dynamically Loaded -->
                </div>
            </div>
        </section>

        <!-- 
        ========================================
        LAYER 4: THE MYTHIC AGE
        THEME: Broken Mosaics / Dusk
        ========================================
        -->
        <section id="mythic-age" class="timeline-layer">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Mythic Age</h2>
                <p class="text-xl text-center text-gray-300 mb-12 italic">"The age of legends, prophecy, and magical cataclysms."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-400 hover:text-white transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Mythic Age. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Dynamically Loaded -->
                </div>
            </div>
        </section>

        <!-- 
        ========================================
        LAYER 3: THE CLASSICAL AGE
        THEME: Mosaics / Night
        ========================================
        -->
        <section id="classical-age" class="timeline-layer">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Classical Age</h2>
                <p class="text-xl text-center text-gray-300 mb-12 italic">"The age of emerging empires, written magic, and wars in the dark."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-400 hover:text-white transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Classical Age. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Dynamically Loaded -->
                </div>
            </div>
        </section>

        <!-- 
        ========================================
        LAYER 2: THE ANCIENT ERA
        THEME: Star-Chart / Deep Space
        ========================================
        -->
        <section id="ancient-era" class="timeline-layer">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Ancient Era</h2>
                <p class="text-xl text-center text-gray-300 mb-12 italic">"The age of myths. History told by the stars, not by mortals."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-400 hover:text-white transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Ancient Era. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="star-chart-container">
                    <!-- Background "filler" stars -->
                    <div class="star" style="top: 10%; left: 10%; width: 2px; height: 2px; animation-delay: -1s;"></div>
                    <div class="star" style="top: 20%; left: 90%; width: 4px; height: 4px; animation-delay: -3s;"></div>
                    <div class="star" style="top: 40%; left: 70%; width: 3px; height: 3px; animation-delay: -2s;"></div>
                    <div class="star" style="top: 65%; left: 5%; width: 2px; height: 2px; animation-delay: -4s;"></div>
                    <div class="star" style="top: 90%; left: 50%; width: 5px; height: 5px; animation-delay: -0.5s;"></div>
                </div>
            </div>
        </section>

        <!-- 
        ========================================
        LAYER 1: THE ANTEDILUVIAN AGE
        THEME: Primordial Chaos / Cosmic Nebula (NOW A STAR-CHART)
        ========================================
        -->
        <section id="antediluvian-age" class="timeline-layer">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-bold mb-4 text-center">The Antediluvian Age</h2>
                <p class="text-xl text-center text-gray-300 mb-12 italic">"Myths whispered from the dawn of time. More feeling than fact."</p>
                <div class="text-center mb-12">
                    <button class="preamble-toggle text-gray-400 hover:text-white transition-colors">More about this era...</button>
                    <div class="preamble-content hidden mt-4 text-left max-w-3xl mx-auto">
                        <p>This is a placeholder for the preamble of the Antediluvian Age. It will contain more information about this period of history.</p>
                    </div>
                </div>
                <div class="star-chart-container">
                    <!-- Background "filler" stars -->
                    <div class="star" style="top: 10%; left: 30%; width: 2px; height: 2px; animation-delay: -1.5s;"></div>
                    <div class="star" style="top: 30%; left: 90%; width: 3px; height: 3px; animation-delay: -2.5s;"></div>
                    <div class="star" style="top: 55%; left: 10%; width: 2px; height: 2px; animation-delay: -3.5s;"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- 
    ========================================
    MODAL (POP-UP) SYSTEM
    ========================================
    -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden opacity-0"></div>

    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0 scale-95">
        <div id="modal-content" class="modal-content-base">
            
            <button id="modal-close-btn">&times;</button>
            
            <h3 id="modal-title" class="text-4xl font-bold mb-2">Event Title Goes Here</h3>
            <p id="modal-date" class="text-lg mb-6">Event Date</p>
            <p id="modal-description" class="text-lg leading-relaxed">Full event description goes here.</p>

            <div class="rumor-box">
                <h4>Rumor</h4>
                <p id="modal-rumor">A random rumor will appear here.</p>
            </div>
        </div>
    </div>


    <script>
        // --- DYNAMIC DATA LOADING & RENDERING ---
        const timelineData = {}; // Global object to hold all event data after fetching.

        // Function to create an event card HTML string
        function createEventCard(event, eraClass) {
            const summary = event.summary || event.description.substring(0, 100) + '...';
            // Specific text color for 'modern' cards, others use the default from their CSS
            const textColorClass = eraClass === 'modern' ? 'text-gray-700' : '';
            const pTag = eraClass !== 'unification' ? `<p class="${textColorClass}">${summary}</p>` : `<p>${event.summary}</p>`
            return `
                <div class="event-trigger event-card ${eraClass}" data-event-id="${event.id}" data-theme="${event.theme}">
                    <p class="event-date text-sm mb-2">${event.date}</p>
                    <h3 class="event-title text-2xl font-bold mb-3">${event.title}</h3>
                    ${pTag}
                </div>
            `;
        }

        // Function to create a star event HTML string for star-chart sections
        function createStarEvent(event) {
            return `
                <div class="event-trigger star clickable" data-event-id="${event.id}" data-theme="${event.theme}" style="top: ${event.position.top}; left: ${event.position.left};">
                    <span class="star-label">${event.title}</span>
                </div>
            `;
        }

        // Main function to fetch data and build the timeline
        async function initializeTimeline() {
            const eras = [
                { id: 'modern-era', file: 'modern-era.json', type: 'card', class: 'modern' },
                { id: 'unification-age', file: 'unification-age.json', type: 'card', class: 'unification' },
                { id: 'mythic-age', file: 'mythic-age.json', type: 'card', class: 'mythic' },
                { id: 'classical-age', file: 'classical-age.json', type: 'card', class: 'classical' },
                { id: 'ancient-era', file: 'ancient-era.json', type: 'star' },
                { id: 'antediluvian-age', file: 'antediluvian-age.json', type: 'star' }
            ];

            try {
                const responses = await Promise.all(eras.map(era => fetch(era.file).then(res => res.json())));

                responses.forEach((eraData, index) => {
                    const era = eras[index];

                    if (era.type === 'card') {
                        const container = document.querySelector(`#${era.id} .grid`);
                        if (container) {
                            let htmlContent = '';
                            eraData.forEach(event => {
                                timelineData[event.id] = event; // Populate global data
                                htmlContent += createEventCard(event, era.class);
                            });
                            container.innerHTML = htmlContent; // Replace content
                        }
                    } else if (era.type === 'star') {
                        const container = document.querySelector(`#${era.id} .star-chart-container`);
                        if (container) {
                            let htmlContent = '';
                             eraData.forEach(event => {
                                timelineData[event.id] = event; // Populate global data
                                htmlContent += createStarEvent(event);
                            });
                            // Append to keep the filler stars
                            container.insertAdjacentHTML('beforeend', htmlContent);
                        }
                    }
                });

                // After all content is injected, re-initialize the modal listeners
                initializeModalListeners();

            } catch (error) {
                console.error("Failed to load timeline data:", error);
                const header = document.querySelector('header');
                if(header) {
                    header.insertAdjacentHTML('afterend', '<p class="text-center text-red-500">Failed to load timeline data. Please try refreshing the page.</p>');
                }
            }
        }

        // --- MODAL SCRIPT (Modified to be initializable) ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const modalTitle = document.getElementById('modal-title');
        const modalDate = document.getElementById('modal-date');
        const modalDescription = document.getElementById('modal-description');
        const modalRumor = document.getElementById('modal-rumor');
        function openModal(eventId) {
            const data = timelineData[eventId];
            if (!data) {
                console.error("No data found for eventId:", eventId);
                return;
            }

            modalTitle.textContent = data.title;
            modalDate.textContent = data.date;
            modalDescription.textContent = data.description;

            const rumor = (() => {
                if (!data.rumors || data.rumors.length === 0) {
                    return "No rumors surround this event. It is a plain and simple fact.";
                }
                const randomIndex = Math.floor(Math.random() * data.rumors.length);
                return data.rumors[randomIndex];
            })();
            modalRumor.textContent = rumor;

            modalContent.className = 'modal-content-base'; // Reset classes
            if (data.theme) {
                modalContent.classList.add(`modal-theme-${data.theme}`);
            }

            modalBackdrop.classList.remove('hidden');
            modalContainer.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('opacity-100');
                modalContainer.classList.add('opacity-100', 'scale-100');
                modalContainer.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.remove('opacity-100');
            modalContainer.classList.remove('opacity-100', 'scale-100');
            modalContainer.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                modalContainer.classList.add('hidden');
            }, 300);
        }
        function initializeModalListeners() {
            const eventTriggers = document.querySelectorAll('.event-trigger');

            function checkUrlForEvent() {
                const params = new URLSearchParams(window.location.search);
                const eventId = params.get('event');
                if (eventId && timelineData[eventId]) {
                    openModal(eventId);
                }
            }

            eventTriggers.forEach(trigger => {
                if (trigger.dataset.listenerAttached) return;

                trigger.addEventListener('click', () => {
                    const eventId = trigger.getAttribute('data-event-id');
                    openModal(eventId);
                });
                trigger.dataset.listenerAttached = 'true';
            });

            if (!modalBackdrop.dataset.listenerAttached) {
                modalBackdrop.addEventListener('click', closeModal);
                modalCloseBtn.addEventListener('click', closeModal);
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !modalContainer.classList.contains('hidden')) {
                        closeModal();
                    }
                });
                modalBackdrop.dataset.listenerAttached = 'true';
            }

            checkUrlForEvent();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTimeline();

            // --- PREAMBLE TOGGLE SCRIPT ---
            document.querySelectorAll('.preamble-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    content.classList.toggle('hidden');
                });
            });

            // --- SIDEBAR SCRIPT ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Close sidebar when a link is clicked
            sidebar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                });
            });
        });
    </script>

</body>
</html>
